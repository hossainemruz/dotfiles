{{ if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "arch") -}}
#!/bin/bash

# Path of the chezmoi repo
CHEZMOI_DIR="$HOME/.local/share/chezmoi"

# Path to the JSON file
JSON_FILE="$CHEZMOI_DIR/webapps.json"

# Directory for icons and .desktop files
ICON_SRC_DIR="$CHEZMOI_DIR/icons"
ICON_DEST_DIR="$HOME/.local/share/applications/icons"
DESKTOP_DIR="$HOME/.local/share/applications"

# Function to check if a web app is already installed
check_installed() {
  local desktop_file="$1"
  if [[ -f "$DESKTOP_DIR/$desktop_file" ]]; then
    echo "$desktop_file is already installed."
    return 0
  else
    echo "$desktop_file is not installed."
    return 1
  fi
}

# Check if jq is installed
if ! command -v jq &> /dev/null; then
  echo "Error: jq is not installed. Please install jq to parse JSON."
  exit 1
fi

# Check if JSON file exists
if [[ ! -f "$JSON_FILE" ]]; then
  echo "Error: JSON file $JSON_FILE not found."
  exit 1
fi

# Check if icon source directory exists
if [[ ! -d "$ICON_SRC_DIR" ]]; then
  echo "Error: Icon source directory $ICON_SRC_DIR not found."
  exit 1
fi

# Create icon and desktop file directories
mkdir -p "$ICON_DEST_DIR"
mkdir -p "$DESKTOP_DIR"

# Read webapps from JSON file
mapfile -t webapps < <(jq -c '.[]' "$JSON_FILE")

# Install each web app
for app in "${webapps[@]}"; do
  # Extract fields using jq
  app_name=$(echo "$app" | jq -r '.name')
  app_url=$(echo "$app" | jq -r '.url')
  icon_name=$(echo "$app" | jq -r '.icon')
  desktop_file=$(echo "$app" | jq -r '.desktop_file')
  profile=$(echo "$app" | jq -r '.profile')

  echo "Processing $app_name..."

  # Define paths
  icon_src_path="$ICON_SRC_DIR/$icon_name"
  icon_dest_path="$ICON_DEST_DIR/$icon_name"

  # Check if icon exists in source directory
  if [[ ! -f "$icon_src_path" ]]; then
    echo "Error: Icon $icon_name not found in $ICON_SRC_DIR."
    continue
  fi

  # Copy icon to destination
  if ! cp "$icon_src_path" "$icon_dest_path"; then
    echo "Error: Failed to copy icon for $app_name."
    continue
  fi

  # Create or overwrite .desktop file
  cat >"$DESKTOP_DIR/$desktop_file" <<EOF
[Desktop Entry]
Version=1.0
Name=$app_name
Comment=$app_name
Exec=omarchy-launch-webapp $app_url --profile-directory=$profile
Terminal=false
Type=Application
Icon=$icon_dest_path
StartupNotify=true
EOF

  # Make .desktop file executable
  if chmod +x "$DESKTOP_DIR/$desktop_file"; then
    echo "$app_name processed successfully."
  else
    echo "Error: Failed to set executable permissions for $desktop_file."
  fi
done

echo "All web app checks and installations complete."
{{ end }}
